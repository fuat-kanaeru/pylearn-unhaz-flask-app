{% extends "layout.html" %}
{% block title %}Kelola Pesan Kontak{% endblock %}
{% block content %}

<div class="container py-5">
    <div class="text-center mb-5">
        <!-- Menggunakan text-white dan text-accent -->
        <h2 class="fw-bolder display-5 text-white mb-2" style="text-shadow: 0 0 8px rgba(255, 255, 255, 0.2);">
            <i class="bi bi-envelope-fill me-3 text-accent"></i> Administrasi Pesan Kontak
        </h2>
        <p class="text-muted fw-light fst-italic">Tinjauan dan manajemen pesan dari pengunjung situs.</p>
    </div>

    <!-- Kotak Informasi Total Pesan (Diambil dari style Daftar Pengguna) -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h4 class="mb-0 text-white fw-bold">
            <!-- Menggunakan kelas 'card' untuk badge glassmorphism ringan -->
            <span class="card p-2 rounded-pill shadow-sm border-0 d-inline-block">
                <i class="bi bi-bell-fill me-1 text-danger"></i> Pesan Baru: {{ unread_count }}
            </span>
        </h4>
        <a href="{{ url_for('admin.dashboard') }}" class="btn btn-outline-primary rounded-pill px-4 shadow-sm transition-all hover-scale">
            ‚Üê Kembali ke Dashboard
        </a>
    </div>

    <!-- Tabel Pesan (Menerapkan kelas 'card' Glassmorphism) -->
    <div class="card p-4 shadow-lg border-0 rounded-4">
        {% if messages %}
            <div class="table-responsive">
                <table class="table table-dark table-hover table-borderless align-middle caption-top">
                    <caption class="text-muted fst-italic">Daftar lengkap pesan kontak yang masuk.</caption>
                    <thead class="border-bottom border-muted-subtle">
                        <tr class="text-white text-uppercase">
                            <th scope="col" class="fw-bold text-center">Status</th>
                            <th scope="col" class="fw-bold">Pengirim</th>
                            <th scope="col" class="fw-bold">Email</th>
                            <th scope="col" class="fw-bold">Subjek</th>
                            <th scope="col" class="fw-bold">Pesan Singkat</th>
                            <th scope="col" class="fw-bold">Waktu Kirim</th>
                            <th scope="col" class="fw-bold text-center">Aksi</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for message in messages %}
                        <!-- Memberikan highlight visual pada pesan yang belum dibaca -->
                        <tr class="{% if not message.is_read %}fw-bold bg-primary bg-opacity-10{% endif %}">
                            <td class="text-center">
                                {% if message.is_read %}
                                    <span class="badge bg-success text-white p-2 fw-normal rounded-pill">Dibaca</span>
                                {% else %}
                                    <span class="badge bg-danger pulse-animation text-white p-2 fw-normal rounded-pill">BARU</span>
                                {% endif %}
                            </td>
                            <td>{{ message.name }}</td>
                            <td><small class="text-muted">{{ message.email }}</small></td>
                            <td>
                                {{ message.subject | default('(Tanpa Subjek)') }}
                            </td>
                            <td>
                                {% set full_message = message.message | default('') %}
                                {% set short_message = full_message[:50] %}
                                
                                <span title="{{ full_message }}" data-bs-toggle="tooltip" data-bs-placement="top" class="text-white-50">
                                    {{ short_message }}
                                    {% if full_message|length > 50 %}...{% endif %}
                                </span>
                            </td>
                            <td>
                                {% if message.timestamp %}
                                    <small class="text-muted">{{ message.timestamp.strftime('%d %b %Y, %H:%M') }}</small>
                                {% else %}
                                    <small class="text-muted">(Tidak diketahui)</small>
                                {% endif %}
                            </td>
                            <td class="text-center">
                                <div class="d-flex flex-column align-items-center space-y-2">
                                    <!-- Toggle Read Status -->
                                    <form method="POST" action="{{ url_for('admin.toggle_read', message_id=message.id) }}" class="mb-1 w-full">
                                        <button type="submit" class="btn btn-sm w-full rounded-3 {% if message.is_read %}btn-warning{% else %}btn-success{% endif %}" title="Ubah status baca">
                                            <i class="bi bi-eye{% if message.is_read %}-slash{% endif %} me-1"></i> 
                                            {% if message.is_read %} Belum Dibaca {% else %} Tandai Dibaca {% endif %}
                                        </button>
                                    </form>
                                    
                                    <!-- Delete Button -->
                                    <form method="POST" action="{{ url_for('admin.delete_contact', message_id=message.id) }}" 
                                          onsubmit="return confirm('Apakah Anda yakin ingin menghapus pesan dari {{ message.name }} secara permanen?')" 
                                          class="w-full">
                                        <button type="submit" class="btn btn-sm btn-danger w-full rounded-3" title="Hapus Permanen">
                                            <i class="bi bi-trash-fill me-1"></i> Hapus Permanen
                                        </button>
                                    </form>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div class="text-center py-5">
                <i class="bi bi-check-circle display-4 text-success mb-3"></i>
                <p class="text-muted mb-0">üéâ Kotak masuk bersih! Tidak ada pesan kontak yang masuk saat ini.</p>
            </div>
        {% endif %}
    </div>
</div>

<style>
    /* Menggunakan variabel dari CSS halaman pengguna */
    :root {
        --primary: #5882FA;
        --accent: #FFC300;
        --bg-light: #2A3052;
        --muted: #B0B0B0;
        --white: #ffffff;
        --glass-bg: rgba(255, 255, 255, 0.15);
    }
    
    /* Style untuk Kotak/Card Glassmorphism */
    .card {
        background: rgba(255, 255, 255, 0.05); /* Latar belakang sangat transparan */
        backdrop-filter: blur(10px); /* Efek blur untuk glass */
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: var(--white);
    }
    
    /* Style Tabel agar sesuai dengan skema gelap glassmorphism */
    .table.table-dark {
        --bs-table-bg: transparent; 
        --bs-table-hover-bg: rgba(255, 255, 255, 0.05);
    }
    
    .table-hover > tbody > tr:hover {
        transition: background-color 0.3s ease;
    }

    /* Animasi sederhana untuk badge 'BARU' */
    @keyframes pulse {
        0% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7); }
        70% { box-shadow: 0 0 0 10px rgba(220, 53, 69, 0); }
        100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); }
    }
    .pulse-animation {
        animation: pulse 1.5s infinite;
    }
    
    /* Memastikan Tooltip bekerja */
    .table td span[data-bs-toggle="tooltip"] {
        cursor: help;
    }
    
    /* Kelas Kustom dari skema sebelumnya (jika masih digunakan di layout) */
    .text-accent { color: var(--accent) !important; }
    .bg-primary { background-color: var(--primary) !important; }
</style>

<script>
    // Script untuk menginisialisasi Tooltip Bootstrap
    document.addEventListener('DOMContentLoaded', function () {
        if (typeof bootstrap !== 'undefined' && bootstrap.Tooltip) {
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl)
            })
        }
    });
</script>

{% endblock %}