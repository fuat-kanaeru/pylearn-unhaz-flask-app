{% extends "layout.html" %}
{% block title %}{{ lesson['title'] }} ‚Äî PyLearn{% endblock %}
{% block content %}

<div class="container py-5">
  <div class="text-center mb-5">
    <h2 class="fw-bold text-accent">{{ lesson['title'] }}</h2>
  </div>

  <div class="card p-4 mb-5">
    <h5 class="fw-semibold mb-3">
        <i class="bi bi-book me-2 text-primary"></i> üìò Materi
    </h5>

    {% if lesson['pdf_url'] %}
      <div class="ratio ratio-16x9 rounded border" style="border-color: var(--glass-border) !important;">
        <iframe src="{{ lesson['pdf_url'] }}" width="100%" height="600px" allow="autoplay" allowfullscreen style="border-radius: 12px;"></iframe>
      </div>
      <div class="mt-3 text-end">
        <a href="{{ lesson['pdf_url'] | replace('/preview','/view') }}" target="_blank" class="btn btn-sm btn-outline-primary">
          <i class="bi bi-box-arrow-up-right me-1"></i> Buka di Google Drive
        </a>
      </div>
    {% elif lesson['content'] %}
      <div class="p-3 rounded" style="background-color: var(--bg-light); border: 1px solid var(--glass-border);">
        {{ lesson['content'] | safe }}
      </div>
    {% else %}
      <p class="text-muted fst-italic">Belum ada konten untuk pelajaran ini.</p>
    {% endif %}
  </div>

  {# ========================================================== #}
  {# BAGIAN SOAL LATIHAN (ISIAN SINGKAT) #}
  {# ========================================================== #}
  {% if questions %}
    <div class="card p-4 mb-4">
      <h5 class="fw-semibold mb-3">
          <i class="bi bi-patch-question me-2 text-primary"></i> üß© Latihan Soal
      </h5>
      
      {# ---------------------------------------------------- #}
      {# 1. SOAL ISIAN SINGKAT (PERBAIKAN LINE BREAK DENGAN <pre>) #}
      {# ---------------------------------------------------- #}
      {% for q in questions %}
        {% set is_answered = q['id'] in answered_ids_short %}
        <div class="mb-3" id="question-container-{{ q['id'] }}">
          
          {# PERBAIKAN: Mengganti <p> dengan <pre> untuk mempertahankan line break dan indentasi #}
          <pre class="fw-semibold question-code">{{ loop.index }}. {{ q['question'] }} <span class="badge bg-secondary ms-2">Isian Singkat</span></pre>
          
          <div class="d-flex gap-2">
            <input type="text" class="form-control answer-input" placeholder="Ketik jawaban..." 
                   data-qid="{{ q['id'] }}" id="input-{{ q['id'] }}"
                   {% if is_answered %} disabled {% endif %}>
            <button class="btn btn-primary check-btn" data-qid="{{ q['id'] }}" id="btn-{{ q['id'] }}" 
                    {% if is_answered %} disabled {% endif %}>
                    Cek
            </button>
          </div>
          <div class="feedback mt-2" id="feedback-{{ q['id'] }}">
            {% if is_answered %}
              <span class='text-success fw-semibold'>‚úÖ Jawaban Benar sudah tersimpan!</span>
            {% endif %}
          </div>
          {% if not loop.last %}
            <div class="my-4" style="height: 1px; background-color: var(--glass-border);"></div>
          {% endif %}
        </div>
      {% endfor %}

    </div>
  {% else %}
    <p class="text-muted fst-italic text-center">Belum ada soal untuk pelajaran ini.</p>
  {% endif %}

  <div class="text-center mt-5">
    <a href="{{ url_for('main.modules') }}" class="btn btn-outline-primary rounded-3">
        <i class="bi bi-arrow-left"></i> Kembali ke Modul Utama
    </a>
  </div>
</div>

{# Script Cek Jawaban (AJAX) - Logika MCQ Dihapus #}
<script>
// ===================================================
// A. LOGIKA UNTUK ISIAN SINGKAT
// ===================================================
document.querySelectorAll('.check-btn').forEach(btn => {
  btn.addEventListener('click', async () => {
    const qid = btn.dataset.qid;
    const input = document.getElementById(`input-${qid}`);
    const feedback = document.getElementById(`feedback-${qid}`);
    const answer = input.value.trim();

    if (!answer) {
      feedback.innerHTML = "<span class='text-danger'>‚ö†Ô∏è Jawaban tidak boleh kosong.</span>";
      return;
    }
    
    btn.disabled = true;

    const res = await fetch("{{ url_for('main.check_answer') }}", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ question_id: qid, answer: answer })
    });
    const data = await res.json();

    if (data.status === "correct") {
      feedback.innerHTML = `<span class='text-success fw-semibold'>‚úÖ ${data.message}</span>`;
      input.disabled = true;
      btn.disabled = true;
    } else if (data.status === "wrong") {
      feedback.innerHTML = `<span class='text-danger fw-semibold'>‚ùå ${data.message}</span>`;
      btn.disabled = false;
    } else {
      feedback.innerHTML = `<span class='text-warning'>${data.message}</span>`;
      btn.disabled = false;
    }
  });
});

</script>

<style>
/* Memaksa warna tulisan di dalam input menjadi putih */
.form-control.answer-input {
    color: var(--white) !important;
}

/* Memaksa warna placeholder menjadi muted */
.form-control.answer-input::placeholder {
    color: var(--muted) !important;
    opacity: 1; 
}

/* ------------------------------------------------ */
/* STYLE BARU UNTUK KODE DENGAN TAG <pre> */
/* ------------------------------------------------ */
pre.question-code {
    white-space: pre-wrap; /* Memastikan baris panjang membungkus */
    font-family: monospace; /* Menggunakan font kode */
    font-size: 1rem; /* Ukuran yang nyaman dibaca */
    color: var(--white); /* Memastikan warna teks tetap putih */
}

/* Styling untuk Pilihan Ganda (Dihapus dari sini, hanya menyisakan style input isian singkat) */

</style>

{% endblock %}
